#Include "rwmake.ch"        // incluido pelo assistente de conversao do AP5 IDE em 05/07/00
#INCLUDE "ETIQMD.CH"

User Function Etiqmd()        // incluido pelo assistente de conversao do AP5 IDE em 05/07/00

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Declaracao de variaveis utilizadas no programa atraves da funcao    Ё
//Ё SetPrvt, que criara somente as variaveis definidas pelo usuario,    Ё
//Ё identificando as variaveis publicas do sistema utilizadas no codigo Ё
//Ё Incluido pelo assistente de conversao do AP5 IDE                    Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды

SetPrvt("CBTXT,CSTRING,AORD,CDESC1,CDESC2,CDESC3")
SetPrvt("LEND,ARETURN,NOMEPROG,AMALADIR,NLASTKEY,CPERG")
SetPrvt("AINFO,AT_PRG,WCABEC0,WCABEC1,WCABEC2,CONTFL")
SetPrvt("LI,NTAMANHO,TITULO,WNREL,NORDEM,CFILDE")
SetPrvt("CFILATE,CCCDE,CCCATE,CMATDE,CMATATE,CNOMEDE")
SetPrvt("CNOMEATE,CCHAPADE,CCHAPAATE,CSITUACAO,CCATEGORIA,DDATAREF")
SetPrvt("NCOLUNAS,CINICIO,CFIM,CINDCOND,CFOR,CARQNTX")
SetPrvt("CHAVE,NCOL,NALIN,CFILIALANT,CCCANT")
SetPrvt("CTIPO")

// Movido para o inicio do arquivo pelo assistente de conversao do AP5 IDE em 05/07/00 ==>    #DEFINE PSAY SAY

// Movido para o inicio do arquivo pelo assistente de conversao do AP5 IDE em 05/07/00 ==> #INCLUDE "ETIQMD.CH"

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё ETIQMD   Ё Autor Ё R.H. - Fernando Joly  Ё Data Ё 07/12/98 Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Emiss└o da Etiqueta para Mala Diretao                      Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso      Ё RdMake                                                     Ё╠╠
╠╠цддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё         ATUALIZACOES SOFRIDAS DESDE A CONSTRU─AO INICIAL.             Ё╠╠
╠╠цддддддддддддбддддддддбддддддбдддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁProgramador Ё Data   Ё BOPS Ё  Motivo da Alteracao                     Ё╠╠
╠╠цддддддддддддеддддддддеддддддедддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁKleber      Ё07/12/98Ё17393aЁConversao para RdMake                     Ё╠╠ 
╠╠ЁMarina      Ё30/08/00Ё------ЁValidacao Filial/Acesso.Limpeza DOS.      Ё╠╠
╠╠ЁPriscila    Ё05/05/03Ё061502ЁAlt. para controlar o salto de pagina.    Ё╠╠
╠╠юддддддддддддаддддддддаддддддадддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ*/
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Define Variaveis Locais (Basicas)                            Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
CbTxt   := ""     //Ambiente
cString := "SRA"  // alias do arquivo principal (Base)
aOrd    := {STR0001,STR0002,STR0003,STR0004} //"Matricula"###"Centro de Custo"###"Nome"###"Chapa"
cDesc1  := STR0005      //"Emiss└o de Etiquetas P/ Mala Direta"
cDesc2  := STR0006      //"Ser═ impresso de acordo com os parametros solicitados pelo"
cDesc3  := STR0007      //"usu═rio."
   
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Define Variaveis Private(Basicas)                            Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
lEnd     := .F.
aReturn  := {STR0008,1,STR0009,2,2,1,"",1 }     //"Zebrado"###"Administra┤└o"
NomeProg := "ETIQMD"
aMalaDir := {}
nLastKey := 0
cPerg    := "GPR360"
   
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Define Variaveis Private(Programa)                           Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
aInfo := {}
   
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Variaveis Utilizadas na funcao IMPR                          Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
AT_PRG   := "ETIQMD"
wCabec0  := 2
wCabec1  := ""
wCabec2  := ""
Contfl   := 1
Li       := 0
nTamanho := "M"

/*
здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
Ё Variaveis de Acesso do Usuario                               Ё
юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
cAcessaSRA	:= &( " { || " + ChkRH( "ETIQMD" , "SRA" , "2" ) + " } " )
 
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Verifica as perguntas selecionadas                           Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
pergunte("GPR360",.F.)
   
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Variaveis utilizadas para parametros                         Ё
//Ё mv_par01        //  Filial De                                Ё
//Ё mv_par02        //  Filial Ate                               Ё
//Ё mv_par03        //  Centro de Custo De                       Ё
//Ё mv_par04        //  Centro de Custo Ate                      Ё
//Ё mv_par05        //  Matricula De                             Ё
//Ё mv_par06        //  Matricula Ate                            Ё
//Ё mv_par07        //  Nome De                                  Ё
//Ё mv_par08        //  Nome Ate                                 Ё
//Ё mv_par09        //  Chapa De                                 Ё
//Ё mv_par10        //  Chapa Ate                                Ё
//Ё mv_par11        //  Situa┤Дes                                Ё
//Ё mv_par12        //  Categorias                               Ё
//Ё mv_par13        //  Data Referencia                          Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
Titulo := STR0010          //"EMISS▌O DE ETIQUETAS P/ MALA DIRETA"
   
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Envia controle para a funcao SETPRINT                        Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
wnrel:="ETIQMD"            //Nome Default do relatorio em Disco
wnrel:=SetPrint(cString,wnrel,cPerg,Titulo,cDesc1,cDesc2,cDesc3,.F.,aOrd,.F.)
   
If nLastKey == 27
   Return
Endif

SetDefault(aReturn,cString)

If nLastKey == 27
   Return
Endif
   
RptStatus({||GR360Imp()})// Substituido pelo assistente de conversao do AP5 IDE em 05/07/00 ==>    RptStatus({||Execute(GR360Imp)})
Return Nil
// Substituido pelo assistente de conversao do AP5 IDE em 05/07/00 ==>    function GR360Imp
Static function GR360Imp()

Local T
   
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Carregando variaveis mv_par?? para Variaveis do Sistema.     Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
nOrdem     := aReturn[8]
cFilDe     := mv_par01
cFilAte    := mv_par02
cCcDe      := mv_par03
cCcAte     := mv_par04
cMatDe     := mv_par05
cMatAte    := mv_par06
cNomeDe    := mv_par07
cNomeAte   := mv_par08
cChapaDe   := mv_par09
cChapaAte  := mv_par10
cSituacao  := mv_par11
cCategoria := mv_par12
dDataref   := mv_par13
nColunas   := If( mv_par14 > 4 , 4 , mv_par14 )
   
dbSelectArea( "SRA" )
If nOrdem == 1
   dbSetOrder( 1 )
ElseIf nOrdem == 2
   dbSetOrder( 2 )
ElseIf nOrdem == 3
   dbSetOrder(3)
ElseIf nOrdem == 4
   dbSetOrder(1)
Endif
   
dbGoTop()
   
If nOrdem == 1
   dbSeek(cFilDe + cMatDe,.T.)
   cInicio := SRA->RA_FILIAL + SRA->RA_MAT
   cFim    := cFilAte + cMatAte
ElseIf nOrdem == 2
   dbSeek(cFilDe + cCcDe + cMatDe,.T.)
   cInicio := SRA->RA_FILIAL + SRA->RA_CC + SRA->RA_MAT
   cFim    := cFilAte + cCcAte + cMatAte
ElseIf nOrdem == 3
   dbSeek(cFilDe + cNomeDe + cMatDe,.T.)
   cInicio := SRA->RA_FILIAL + SRA->RA_NOME + SRA->RA_MAT
   cFim    := cFilAte + cNomeAte + cMatAte
ElseIf nOrdem == 4
   dbSeek(cFilDe + cMatDe,.T.)
   cInicio := SRA->RA_FILIAL + SRA->RA_MAT
   cFim    := cFilAte + cMatAte
Endif
   
#IFNDEF TOP
   If nOrdem == 4
      cIndCond:= "SRA->RA_FILIAL + SRA->RA_CHAPA"
      cFor :="(SRA->RA_FILIAL + SRA->RA_CHAPA >= cFilDe + cChapaDe) "
      cFor := cFor + ".And. (SRA->RA_FILIAL + SRA->RA_CHAPA <= cFilAte + cChapaAte)"
   Endif
#ELSE
   If nOrdem == 4
      cIndCond:= "SRA->RA_FILIAL + SRA->RA_CHAPA"
      cFor :='(RA_FILIAL + RA_CHAPA >= "'+cFilDe + cChapaDe+'")'
      cFor := cFor + '.And. (RA_FILIAL + RA_CHAPA <= "'+cFilAte + cChapaAte+'")'
   Endif
#ENDIF
   
If nOrdem == 4
   cArqNtx  := CriaTrab(Nil,.F.)
   IndRegua("SRA",cArqNtx,cIndCond,,cFor,STR0011)  //"Selecionando Registros..."
Endif
   
dbSelectArea( "SRA" )
SetRegua(SRA->(RecCount()))
   
Chave      := 0
Li         := PROW()
nCol       := 1
nAlin      := 0
If aReturn[5] # 1 
	Li         := PROW()  // PROW - Informe em que linha o carro de impressao esta posicionado//
//	@Li ,0 PSAY chr(12)
EndIf

For T:=1 TO nColunas
   aAdd(aMalaDir,{" "," "," "," "," "," "," "," "})
Next 

cFilialAnt := "  "
cCcAnt     := Space(9)

//@Li ,0 PSAY chr(12)
   
dbSelectArea( "SRA" )
While !Sra->(Eof()) .And. Chave == 0
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Movimenta Regua Processamento                                Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	IncRegua()
         
	If SRA->RA_FILIAL #cFilialAnt
		If !fInfo(@aInfo,SRA->RA_FILIAL)
			Chave := 1
			Exit
		Endif
		dbSelectArea( "SRA" )
		cFilialAnt := SRA->RA_FILIAL
	Endif
     

	While !Eof() .And. SRA->RA_FILIAL == cFilialAnt
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Movimenta Regua Processamento                                Ё
      	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		IncRegua()

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica o De / Ate Solicitado                               Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		IF &(IndexKey()) > cFim .Or. Sra->(Eof())
			Chave := 1
			Exit
		ENDIF
            
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cancela Impresфo ao se pressionar <ALT> + <A>                Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If lEnd
			Set Device to Printer
			@Prow()+1,0 PSAY cCancela
			Set Device to Screen  
			Chave := 1
			Exit
		EndIF
         
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Consiste Parametriza┤фo do Intervalo de Impressфo            Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If	(Sra->Ra_Chapa < cChapaDe) .Or. (Sra->Ra_Chapa > cChapaAte) .Or. ;
			(Sra->Ra_Nome < cNomeDe) .Or. (Sra->Ra_Nome > cNomeAte) .Or. ;
			(Sra->Ra_Mat < cMatDe) .Or. (Sra->Ra_Mat > cMatAte) .Or. ;
			(Sra->Ra_CC < cCcDe) .Or. (Sra->Ra_CC > cCCAte)
			Sra->(dbSkip(1))
		Loop
		EndIf

		/*
		зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		ЁConsiste Filiais e Acessos                                             Ё
		юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды*/
		IF !( SRA->RA_FILIAL $ fValidFil() .and. Eval( cAcessaSRA ) )
			dbSelectArea("SRA")
			dbSkip()
			Loop
		EndIF
         
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Verifica Situacao e Categoria do Funcionario                 Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If !( SRA->RA_SITFOLH $ cSituacao ) .OR. !( SRA->RA_CATFUNC $ cCategoria )
			Sra->(dbSkip(1))
			Loop
		Endif
		nAlin := nAlin+1
   
		aMalaDir[nAlin,1] := SRA->RA_NOME
		aMalaDir[nAlin,2] := SRA->RA_ENDERECO
		aMalaDir[nAlin,3] := SRA->RA_COMPLEME + " " + SRA->RA_BAIRRO
		aMalaDir[nAlin,4] := SRA->RA_MUNICIP + " " + SRA->RA_ESTADO + " " + Left(SRA->RA_CEP,5) + "-" + Right(SRA->RA_CEP,3)
		aMalaDir[nAlin,5] := SRA->RA_FILIAL + "-" + SRA->RA_MAT + "-" + SRA->RA_CC
		cTipo := "I"
		fChkETMD()
	dbSkip()
	EndDo
	IF Chave == 1
		Exit
	EndIf

	If Eof()
		Exit
	EndIf
Enddo
cTipo:="F"
fChkETMD()
//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Termino do Relatorio                                         Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
dbSelectArea( "SRA" )
Set Filter to
dbSetOrder(1)
   
If nOrdem == 4
	fErase( cArqNtx + OrdBagExt() )
EndIf
   
Set Device To Screen
   
If aReturn[5] == 1
	Set Printer To
	dbCommit()
	OurSpool(WnRel)
EndIf
   
MS_FLUSH()

*-------------------------------------
// Substituido pelo assistente de conversao do AP5 IDE em 05/07/00 ==> FuncTion fChkETMD
Static FuncTion fChkETMD()
*-------------------------------------

Local C
Local I

If (cTipo == "I" .And. nAlin == nColunas) .Or. (cTipo == "F" .And. nAlin > 0)
   For C:= 1 To 5
      nCol:=0
      For I:= 1 To nColunas       
          @ Li,nCol PSAY aMalaDir[I,C]
          nCol := nCol + 44
          aMalaDir[I,C]:= " "
      Next
      Li := Li + 1
   Next
   nAlin:=0              
	Li := Li + 1
Endif

If Li >= 56
	Li := 0
EndIf 

If cTipo == "F"
   @ Li, 0 PSAY " "
Endif

Return(nil)        // incluido pelo assistente de conversao do AP5 IDE em 05/07/00

